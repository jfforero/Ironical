<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Evaluation - Debug Version</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      color: #333;
      display: flex;
      justify-content: center;
      padding: 2em;
    }
    #container {
      width: 100%;
      max-width: 800px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 2em;
      text-align: center;
    }
    audio {
      width: 100%;
      margin: 1.5em 0;
    }
    iframe {
      width: 100%;
      height: 1600px;
      border: none;
      border-radius: 8px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.75em 1.5em;
      font-size: 1em;
      cursor: pointer;
      margin-top: 1em;
    }
    button:hover {
      background: #1e40af;
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    .error {
      color: #dc2626;
      background: #fef2f2;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
    }
    .success {
      color: #059669;
      background: #f0fdf4;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
    }
    #fileList {
      text-align: left;
      background: #f8fafc;
      padding: 1em;
      border-radius: 8px;
      margin: 1em 0;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div id="container">
    <h2>Audio Evaluation - File Check</h2>
    <div id="status"></div>
    <div id="fileList"></div>
    <p id="progress"></p>
    <div id="errorMessage" class="error" style="display: none;"></div>
    <audio id="audioPlayer" controls></audio>

    <!-- Embedded Google Form -->
    <iframe id="formFrame"></iframe>
    <p>Please SUBMIT your answers before proceeding to the next audio file.</p>

    ‚úÖ <span style="color: #d63031; text-transform: uppercase; text-decoration: underline;">SUBMIT</span> your answers before proceeding to the next audio file

    <button id="nextBtn" disabled>Next Sample</button>
    <button id="startBtn" style="background: #059669;">Start Evaluation</button>
  </div>

  <script>
    /**********************
     * CONFIGURATION AREA *
     **********************/

    // Define audio tags and number of files per tag
    const tags = ['K1_', 'S4_', 'S14N_', 'S1H4_'];
    const numFiles = 13;

    const formBaseURL = "https://docs.google.com/forms/d/e/1FAIpQLSflygks3jJjGm4_J-CJVH1dqJpzMLb10rd8QpfsH63mWeaLNA/viewform?embedded=true&usp=pp_url";
    const sampleFieldID = "entry.1636001789";

    /**********************
     * PAGE FUNCTIONALITY *
     **********************/

    let audioFiles = [];
    let availableAudioFiles = [];
    let currentIndex = 0;

    const player = document.getElementById('audioPlayer');
    const progress = document.getElementById('progress');
    const formFrame = document.getElementById('formFrame');
    const nextBtn = document.getElementById('nextBtn');
    const startBtn = document.getElementById('startBtn');
    const errorMessage = document.getElementById('errorMessage');
    const statusDiv = document.getElementById('status');
    const fileListDiv = document.getElementById('fileList');

    // Generate all possible file paths
    function generateAudioFiles() {
      audioFiles = [];
      tags.forEach(tag => {
        for (let i = 1; i <= numFiles; i++) {
          const idx = String(i).padStart(3, '0');
          
          // Try multiple possible path formats
          const possiblePaths = [
            `audio/${tag}${idx}.wav`,
            `/${tag}${idx}.wav`,
            `./audio/${tag}${idx}.wav`,
            `${tag}${idx}.wav`,
            `https://jfforero.github.io/audio/${tag}${idx}.wav`
          ];
          
          // Add all possibilities
          possiblePaths.forEach(path => {
            audioFiles.push(path);
          });
        }
      });
      
      // Remove duplicates
      audioFiles = [...new Set(audioFiles)];
      return audioFiles;
    }

    // Function to check if audio file exists
    async function checkAudioFileExists(url) {
      try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // Check all files and display results
    async function checkAllFiles() {
      statusDiv.innerHTML = '<p>üîç Checking audio files... This may take a moment.</p>';
      fileListDiv.innerHTML = '';
      
      availableAudioFiles = [];
      const foundFiles = [];
      const missingFiles = [];
      
      // Generate files first
      generateAudioFiles();
      
      // Check each file
      for (let i = 0; i < audioFiles.length; i++) {
        const file = audioFiles[i];
        const exists = await checkAudioFileExists(file);
        
        if (exists) {
          availableAudioFiles.push(file);
          foundFiles.push(file);
          fileListDiv.innerHTML += `<div style="color: green;">‚úÖ ${file}</div>`;
        } else {
          missingFiles.push(file);
          fileListDiv.innerHTML += `<div style="color: red;">‚ùå ${file}</div>`;
        }
        
        // Update status
        statusDiv.innerHTML = `<p>üîç Checking files... (${i + 1}/${audioFiles.length}) - Found: ${foundFiles.length}</p>`;
        
        // Small delay to avoid overwhelming requests
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // Final status
      if (availableAudioFiles.length > 0) {
        statusDiv.innerHTML = `<div class="success">
          <h3>‚úÖ Ready to Start!</h3>
          <p>Found ${availableAudioFiles.length} audio files.</p>
          <p>Click "Start Evaluation" to begin.</p>
        </div>`;
        startBtn.disabled = false;
        nextBtn.disabled = false;
      } else {
        statusDiv.innerHTML = `<div class="error">
          <h3>‚ùå No Audio Files Found</h3>
          <p>No audio files were found at the expected locations.</p>
          <p>Please check that your audio files are uploaded to your GitHub repository.</p>
          <p><strong>Expected location:</strong> <code>https://jfforero.github.io/audio/</code></p>
        </div>`;
        startBtn.disabled = true;
        nextBtn.disabled = true;
      }
      
      // Randomize the order of available files
      availableAudioFiles.sort(() => Math.random() - 0.5);
    }

    function loadAudio() {
      if (currentIndex >= availableAudioFiles.length) {
        document.getElementById('container').innerHTML = `
          <h2>All samples evaluated ‚úÖ</h2>
          <p>Thank you for your participation!</p>
          <p>You evaluated ${availableAudioFiles.length} audio samples.</p>`;
        return;
      }

      const file = availableAudioFiles[currentIndex];
      player.src = file;
      player.load();
      progress.textContent = `Sample ${currentIndex + 1} of ${availableAudioFiles.length} - ${file}`;

      // Prefill hidden field with encoded filename
      const encodedFile = encodeURIComponent(file);
      const formURL = `${formBaseURL}&${sampleFieldID}=${encodedFile}`;
      formFrame.src = formURL;
      
      console.log(`Loading: ${file}`);
    }

    nextBtn.addEventListener('click', () => {
      currentIndex++;
      loadAudio();
    });

    startBtn.addEventListener('click', () => {
      statusDiv.style.display = 'none';
      fileListDiv.style.display = 'none';
      startBtn.style.display = 'none';
      nextBtn.disabled = false;
      loadAudio();
    });

    // Initialize - check files on page load
    checkAllFiles();
  </script>
</body>
</html>
